---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: external-dns-credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: external-secretstore
    kind: SecretStore
  target:
    name: external-dns-credentials
    creationPolicy: Owner
  data:
    - secretKey: CF_API_TOKEN
      remoteRef:
        key: prod/CloudFlare/ExternalDnsCredentials
        property: CF_API_TOKEN
    - secretKey: CF_API_EMAIL
      remoteRef:
        key: prod/CloudFlare/ExternalDnsCredentials
        property: CF_API_EMAIL
---
kind: CronJob
apiVersion: batch/v1
metadata:
  name: cloudflare-dns-records-sync
spec:
  successfulJobsHistoryLimit: 1
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: cloudflare-dns-records-sync
              image: alpine:3.18
              env:
                - name: CF_API_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: external-dns-credentials
                      key: CF_API_TOKEN
              command: ["/bin/sh", "-c"]
              args:
                - |
                  apk update
                  apk add --no-cache curl
                  ZONE_ID=89a11213078594f0de740ed5f38a3148
                  RECORD_ID=3aa2cc0db5d9d426abeb17fbd3685df4
                  PUBLIC_IP=$(curl -s https://ipinfo.io/ip)
                  curl -X PUT "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
                       -H "Authentication: Bearer $CF_API_TOKEN" \
                       -H "Content-Type: application/json" \
                       --data @- <<EOF
                          {
                            "type": "A",
                            "name": "*.pyldin601.xyz",
                            "content": "$PUBLIC_IP",
                            "ttl": 120,
                            "proxied": false
                          }
                        EOF
                  echo $PUBLIC_IP
          restartPolicy: OnFailure
